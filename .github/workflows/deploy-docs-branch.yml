name: Deploy Documentation (Docs Branch)

on:
  push:
    branches: [docs]
    paths:
      - 'docs/**'
      - 'vercel-docs.json'
      - 'package-docs.json'
  pull_request:
    branches: [docs]
    paths:
      - 'docs/**'
  workflow_dispatch:

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_DOCS_PROJECT_ID }}

jobs:
  validate-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout docs branch
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Validate documentation structure
        run: |
          echo "ğŸ” Validating documentation structure..."

          # Check required files
          required_files=("docs/index.md" "vercel-docs.json" "package-docs.json")
          for file in "${required_files[@]}"; do
            if [[ -f "$file" ]]; then
              echo "âœ… $file exists"
            else
              echo "âŒ $file is missing"
              exit 1
            fi
          done

          # Check markdown files
          find docs -name "*.md" -type f | while read file; do
            echo "ğŸ“„ Checking $file"
            if ! grep -q "^# " "$file"; then
              echo "âš ï¸ Warning: $file may be missing a main heading"
            fi
          done

  deploy-docs:
    runs-on: ubuntu-latest
    needs: validate-docs
    if: github.ref == 'refs/heads/docs'
    environment: production
    steps:
      - name: Checkout docs branch
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Deploy to Vercel
        run: |
          vercel --token=${{ secrets.VERCEL_TOKEN }} \
                 --config=vercel-docs.json \
                 --prod \
                 --confirm
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

      - name: Create deployment summary
        run: |
          echo "## ğŸ“š Documentation Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸŒ **URL**: https://docs.itsdifferentproductions.com" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“… **Deployed**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“ **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "ğŸŒ¿ **Branch**: docs" >> $GITHUB_STEP_SUMMARY

      - name: Notify Discord
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{"content":"ğŸ“š Documentation deployed from docs branch!\nğŸŒ https://docs.itsdifferentproductions.com\nâ° '$(date)'"}' \
            ${{ secrets.DISCORD_WEBHOOK_URL }} || true
